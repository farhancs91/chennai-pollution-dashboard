<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chennai Pollution Dashboard</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Papa Parse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    html, body { height: 100%; }
    #map { height: 420px; }
    .card { border-radius: 1rem; box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-800">
  <header class="mx-auto max-w-7xl px-4 py-6">
    <h1 class="text-3xl font-bold">Chennai Pollution Dashboard</h1>
    <p class="text-sm text-gray-600 mt-1">
      Pick a pollution type (Air or Noise). Data is editable at <code>data/localities.csv</code>.
      If CSV isn’t found, sample data is shown.
    </p>
  </header>

  <main class="mx-auto max-w-7xl px-4 pb-16 space-y-6">
    <!-- Controls -->
    <section class="card bg-white p-4">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
        <div>
          <label class="block text-sm font-medium">Pollution Type</label>
          <select id="typeSelect" class="mt-1 rounded-xl border w-56 p-2">
            <option value="air">Air Pollution</option>
            <option value="noise">Noise Pollution</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium">Filter by locality</label>
          <input id="searchInput" placeholder="Type to filter (e.g., Adyar)" class="mt-1 rounded-xl border w-64 p-2" />
        </div>
        <div class="text-sm text-gray-600">
          <span>Status: <span id="statusText">Loading…</span></span>
          <span class="ml-3">Updated: <span id="lastUpdated">--</span></span>
        </div>
      </div>
    </section>

    <!-- Map -->
    <section class="card bg-white p-4">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-xl font-semibold">Map</h2>
        <div class="text-xs text-gray-500">Bubble size & color reflect the selected pollution type.</div>
      </div>
      <div id="map" class="rounded-2xl"></div>
      <div class="mt-3 text-xs text-gray-600">
        Map data © OpenStreetMap contributors. Markers are approximate centers of each locality.
      </div>
    </section>

    <!-- Charts -->
    <section class="grid md:grid-cols-2 gap-6">
      <div class="card bg-white p-4">
        <h2 class="text-xl font-semibold mb-2">Top 5 Localities (by selected type)</h2>
        <canvas id="topChart" height="220"></canvas>
      </div>
      <div class="card bg-white p-4">
        <h2 class="text-xl font-semibold mb-2">Air vs Noise (overview)</h2>
        <canvas id="compareChart" height="220"></canvas>
      </div>
    </section>

    <!-- Table -->
    <section class="card bg-white p-4">
      <h2 class="text-xl font-semibold mb-3">Data Table</h2>
      <div class="overflow-x-auto">
        <table id="dataTable" class="min-w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="text-left p-2">Locality</th>
              <th class="text-left p-2">Air (PM2.5)</th>
              <th class="text-left p-2">Noise (Avg dB)</th>
              <th class="text-left p-2">Updated</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

<script>
/* ---------- Inline fallback data (works even if CSV fails) ---------- */
const INLINE_DATA = [
  { locality:"T. Nagar",      lat:13.0418, lon:80.2340, pm25:58, pm10:92, no2:34, o3:21, noise_day_db:72, noise_night_db:64, updated_at:"2025-10-01" },
  { locality:"Anna Nagar",    lat:13.0860, lon:80.2101, pm25:46, pm10:78, no2:28, o3:25, noise_day_db:68, noise_night_db:60, updated_at:"2025-10-01" },
  { locality:"Adyar",         lat:13.0067, lon:80.2570, pm25:39, pm10:63, no2:22, o3:27, noise_day_db:66, noise_night_db:58, updated_at:"2025-10-01" },
  { locality:"Velachery",     lat:12.9792, lon:80.2212, pm25:52, pm10:85, no2:31, o3:20, noise_day_db:73, noise_night_db:66, updated_at:"2025-10-01" },
  { locality:"Tambaram",      lat:12.9249, lon:80.1275, pm25:44, pm10:72, no2:24, o3:18, noise_day_db:65, noise_night_db:57, updated_at:"2025-10-01" },
  { locality:"Perambur",      lat:13.1077, lon:80.2377, pm25:60, pm10:95, no2:38, o3:19, noise_day_db:75, noise_night_db:68, updated_at:"2025-10-01" },
  { locality:"Royapuram",     lat:13.1143, lon:80.2931, pm25:55, pm10:88, no2:36, o3:23, noise_day_db:74, noise_night_db:67, updated_at:"2025-10-01" },
  { locality:"Mylapore",      lat:13.0338, lon:80.2696, pm25:42, pm10:70, no2:26, o3:22, noise_day_db:67, noise_night_db:59, updated_at:"2025-10-01" },
  { locality:"Nungambakkam",  lat:13.0588, lon:80.2425, pm25:50, pm10:82, no2:30, o3:24, noise_day_db:71, noise_night_db:63, updated_at:"2025-10-01" },
  { locality:"Teynampet",     lat:13.0424, lon:80.2543, pm25:49, pm10:80, no2:29, o3:21, noise_day_db:70, noise_night_db:62, updated_at:"2025-10-01" },
  { locality:"Guindy",        lat:13.0108, lon:80.2121, pm25:51, pm10:83, no2:32, o3:20, noise_day_db:72, noise_night_db:64, updated_at:"2025-10-01" },
  { locality:"Saidapet",      lat:13.0197, lon:80.2237, pm25:47, pm10:76, no2:27, o3:23, noise_day_db:69, noise_night_db:61, updated_at:"2025-10-01" },
  { locality:"Alwarpet",      lat:13.0396, lon:80.2549, pm25:41, pm10:66, no2:24, o3:25, noise_day_db:65, noise_night_db:57, updated_at:"2025-10-01" },
  { locality:"Besant Nagar",  lat:12.9985, lon:80.2667, pm25:38, pm10:61, no2:21, o3:27, noise_day_db:63, noise_night_db:56, updated_at:"2025-10-01" },
  { locality:"Thiruvanmiyur", lat:12.9869, lon:80.2590, pm25:40, pm10:64, no2:22, o3:26, noise_day_db:64, noise_night_db:56, updated_at:"2025-10-01" },
  { locality:"Sholinganallur",lat:12.9010, lon:80.2273, pm25:45, pm10:74, no2:26, o3:24, noise_day_db:68, noise_night_db:61, updated_at:"2025-10-01" },
  { locality:"Medavakkam",    lat:12.9166, lon:80.1999, pm25:43, pm10:71, no2:25, o3:24, noise_day_db:67, noise_night_db:60, updated_at:"2025-10-01" },
  { locality:"Pallikaranai",  lat:12.9496, lon:80.2181, pm25:48, pm10:79, no2:28, o3:22, noise_day_db:70, noise_night_db:62, updated_at:"2025-10-01" },
  { locality:"Chromepet",     lat:12.9495, lon:80.1381, pm25:47, pm10:77, no2:27, o3:21, noise_day_db:69, noise_night_db:61, updated_at:"2025-10-01" },
  { locality:"Pallavaram",    lat:12.9675, lon:80.1500, pm25:46, pm10:75, no2:27, o3:21, noise_day_db:68, noise_night_db:60, updated_at:"2025-10-01" },
  { locality:"Meenambakkam",  lat:12.9859, lon:80.1636, pm25:45, pm10:74, no2:26, o3:22, noise_day_db:69, noise_night_db:61, updated_at:"2025-10-01" },
  { locality:"Porur",         lat:13.0465, lon:80.1588, pm25:52, pm10:86, no2:33, o3:20, noise_day_db:73, noise_night_db:65, updated_at:"2025-10-01" },
  { locality:"Ambattur",      lat:13.1149, lon:80.1548, pm25:51, pm10:84, no2:31, o3:20, noise_day_db:72, noise_night_db:64, updated_at:"2025-10-01" },
  { locality:"Avadi",         lat:13.1155, lon:80.1017, pm25:49, pm10:81, no2:30, o3:19, noise_day_db:71, noise_night_db:63, updated_at:"2025-10-01" },
  { locality:"Poonamallee",   lat:13.0487, lon:80.0970, pm25:48, pm10:79, no2:28, o3:20, noise_day_db:69, noise_night_db:61, updated_at:"2025-10-01" },
  { locality:"Koyambedu",     lat:13.0694, lon:80.2050, pm25:56, pm10:90, no2:35, o3:19, noise_day_db:74, noise_night_db:66, updated_at:"2025-10-01" },
  { locality:"Kilpauk",       lat:13.0791, lon:80.2357, pm25:50, pm10:82, no2:30, o3:21, noise_day_db:70, noise_night_db:62, updated_at:"2025-10-01" },
  { locality:"Egmore",        lat:13.0733, lon:80.2611, pm25:49, pm10:80, no2:29, o3:22, noise_day_db:69, noise_night_db:61, updated_at:"2025-10-01" },
  { locality:"Choolai",       lat:13.0900, lon:80.2645, pm25:51, pm10:83, no2:31, o3:21, noise_day_db:71, noise_night_db:63, updated_at:"2025-10-01" },
  { locality:"Washermenpet",  lat:13.1166, lon:80.2937, pm25:57, pm10:92, no2:36, o3:19, noise_day_db:75, noise_night_db:67, updated_at:"2025-10-01" },
  { locality:"Korukkupet",    lat:13.1213, lon:80.2808, pm25:56, pm10:91, no2:35, o3:19, noise_day_db:74, noise_night_db:66, updated_at:"2025-10-01" },
  { locality:"Tiruvottiyur",  lat:13.1578, lon:80.3022, pm25:54, pm10:88, no2:34, o3:20, noise_day_db:73, noise_night_db:65, updated_at:"2025-10-01" },
  { locality:"Ennore",        lat:13.2150, lon:80.3220, pm25:58, pm10:95, no2:38, o3:18, noise_day_db:76, noise_night_db:68, updated_at:"2025-10-01" },
  { locality:"Madhavaram",    lat:13.1482, lon:80.2437, pm25:52, pm10:85, no2:32, o3:20, noise_day_db:72, noise_night_db:64, updated_at:"2025-10-01" },
  { locality:"Perungudi",     lat:12.9650, lon:80.2410, pm25:49, pm10:80, no2:29, o3:22, noise_day_db:69, noise_night_db:61, updated_at:"2025-10-01" },
  { locality:"Thoraipakkam",  lat:12.9396, lon:80.2417, pm25:50, pm10:82, no2:30, o3:21, noise_day_db:70, noise_night_db:62, updated_at:"2025-10-01" },
  { locality:"Adambakkam",    lat:12.9885, lon:80.1994, pm25:45, pm10:74, no2:27, o3:23, noise_day_db:67, noise_night_db:59, updated_at:"2025-10-01" },
  { locality:"Ayanavaram",    lat:13.0981, lon:80.2315, pm25:50, pm10:81, no2:30, o3:21, noise_day_db:70, noise_night_db:62, updated_at:"2025-10-01" },
  { locality:"Vepery",        lat:13.0800, lon:80.2600, pm25:49, pm10:79, no2:29, o3:22, noise_day_db:69, noise_night_db:61, updated_at:"2025-10-01" }
];

/* ---------- App state ---------- */
const state = { raw: [], filtered: [], map: null, markers: [], topChart: null, compareChart: null };

/* ---------- Helpers ---------- */
function valueForType(row, type) {
  if (type === 'noise') return (Number(row.noise_day_db) + Number(row.noise_night_db)) / 2; // Avg dB
  return Number(row.pm25); // Air pollution proxy (PM2.5)
}
function typeLabel(type) { return type === 'noise' ? 'Noise (Avg dB)' : 'Air Pollution (PM2.5)'; }
function aqColor(value, type) {
  const [min,max] = type === 'noise' ? [40,85] : [0,150];
  const t = Math.max(0, Math.min(1, (value - min) / (max - min)));
  const hue = (1 - t) * 120; // green→red
  return `hsl(${hue}, 80%, 45%)`;
}
function bubbleRadius(value, type) {
  const [min,max] = type === 'noise' ? [40,85] : [0,150];
  const t = Math.max(0.2, Math.min(1, (value - min) / (max - min)));
  return 12 + t * 18;
}

/* ---------- Map ---------- */
function initMap() {
  state.map = L.map('map').setView([13.0827, 80.2707], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(state.map);
}
function clearMarkers() { state.markers.forEach(m => m.remove()); state.markers = []; }
function drawMarkers(type) {
  clearMarkers();
  state.filtered.forEach(row => {
    const value = valueForType(row, type);
    const marker = L.circleMarker([Number(row.lat), Number(row.lon)], {
      radius: bubbleRadius(value, type),
      fillColor: aqColor(value, type),
      fillOpacity: 0.75,
      color: '#333',
      weight: 1
    }).bindPopup(`<b>${row.locality}</b><br/>${typeLabel(type)}: <b>${value.toFixed(1)}</b>`);
    marker.addTo(state.map);
    state.markers.push(marker);
  });
}

/* ---------- Charts ---------- */
function buildTopChart(type) {
  const ctx = document.getElementById('topChart');
  const sorted = [...state.filtered].sort((a,b)=>valueForType(b,type)-valueForType(a,type)).slice(0,5);
  const labels = sorted.map(r=>r.locality);
  const data = sorted.map(r=>Number(valueForType(r,type).toFixed(1)));
  if (state.topChart) state.topChart.destroy();
  state.topChart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label: typeLabel(type), data }] },
    options: { responsive: true, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
  });
}
function buildCompareChart() {
  const ctx = document.getElementById('compareChart');
  const labels = state.filtered.map(r=>r.locality);
  const air = state.filtered.map(r=>Number(valueForType(r,'air').toFixed(1)));
  const noise = state.filtered.map(r=>Number(valueForType(r,'noise').toFixed(1)));
  if (state.compareChart) state.compareChart.destroy();
  state.compareChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label: 'Air (PM2.5)', data: air }, { label: 'Noise (Avg dB)', data: noise }] },
    options: { responsive: true, plugins: { legend: { display: true } }, interaction: { mode: 'index', intersect: false }, scales: { y: { beginAtZero: true } } }
  });
}

/* ---------- Table & Filters ---------- */
function renderTable() {
  const tbody = document.querySelector('#dataTable tbody');
  tbody.innerHTML = '';
  state.filtered.forEach(r => {
    const air = valueForType(r,'air').toFixed(1);
    const noise = valueForType(r,'noise').toFixed(1);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-2">${r.locality}</td>
      <td class="p-2">${air}</td>
      <td class="p-2">${noise}</td>
      <td class="p-2">${r.updated_at}</td>`;
    tbody.appendChild(tr);
  });
}
function applyFilter() {
  const q = document.getElementById('searchInput').value.toLowerCase().trim();
  state.filtered = state.raw.filter(r => (r.locality||'').toLowerCase().includes(q));
}
function updateLastUpdated() {
  const dates = state.filtered.map(r => r.updated_at);
  const last = dates.sort().slice(-1)[0] || '--';
  document.getElementById('lastUpdated').textContent = last;
}

/* ---------- CSV loader with cache-busting + fallback ---------- */
async function loadData() {
  return new Promise((resolve) => {
    Papa.parse('./data/localities.csv?ts=' + Date.now(), {
      header: true,
      download: true,
      complete: (results) => {
        const rows = (results.data || []).filter(r => r.locality);
        if (rows.length) { document.getElementById('statusText').textContent = 'CSV loaded'; resolve(rows); }
        else { document.getElementById('statusText').textContent = 'CSV empty → showing sample data'; resolve(INLINE_DATA); }
      },
      error: () => { document.getElementById('statusText').textContent = 'CSV missing → showing sample data'; resolve(INLINE_DATA); }
    });
  });
}

/* ---------- Boot ---------- */
document.addEventListener('DOMContentLoaded', async () => {
  initMap();
  state.raw = await loadData();
  state.filtered = [...state.raw];

  const typeSelect = document.getElementById('typeSelect');
  const searchInput = document.getElementById('searchInput');

  typeSelect.addEventListener('change', () => refresh(typeSelect.value));
  searchInput.addEventListener('input', () => refresh(typeSelect.value));

  refresh(typeSelect.value);
});

function refresh(type) {
  applyFilter();
  drawMarkers(type);
  renderTable();
  buildTopChart(type);
  buildCompareChart();
  updateLastUpdated();
}
</script>
</body>
</html>
